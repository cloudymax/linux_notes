# Linux Script order

reference notes for boot order things since we're in hypervisor land

## Bios initialization

- __POST__
- __MBR__
  - 512 bytes at 1st sector of disk
  - first 446 bytes are code, next 64 is 16x4 partitions
  - last 2 bytes are MBR signiture

## GRUB2

### stage 1

- __boot.img__ is stored in the __MBR__, or volume of boot record
- uses LBA48 address and loads __core.img__

### stage 1.5

- __core.img__ is written between MBR and 1st partition
- first sector is s0 then at s63, there is a __63 sector gap__
- __core.img__ loads filesystem drivers
- at install time it is generated by __diskboot.img__

### stage 2

- files for this stage live at __/boot/grub-directory__
- __grub.conf__ lets you specify which OS/files to use

- __root (hd0,0)__
specifies the partition on which a compressed kernel image and initrd file are located.

- __kernel /vmlinuz-2.6.18-238.el5 ro root=/dev/VolGroup00/LogVol00__
tells which kernel image to use

- __initrd /initrd-2.6.18-238.el5.img__
the location of initrd

- __initrd__ loads the required modules for disk read

## Kernel initialization

- __init__
starts first, parent of all processes, PIDS start with 1. Settings are stored in /etc/inittab

## Boot

- __/etc/rc.d/rc.sysinit__:
first script run by system, interractive on first run for system setup

- __/etc/rc.d/rc<$run_level>.d__:
scripts in this folder specified by the default runlevel in inittab are now run

- __/etc/rc.local__:
runs after all other boot scripts

## Login

- __/etc/profile__:
system wide env vars, initial path

- __~/.bash_profile__:
if it exists, its executed after /etc/profile on login

- __~/.bash_login__:
executed it no profile exists

- __~/.profile__:
if no bash_profile or bash_login exists, run this

- __~/.bashrc__:
executed on non-interractive shell start

- __~/etc/bashrc__:
system-wide, runs on shell launch

- __~/bash_logout__:
runs on user loging out

## Run Levels

- __0__: Halt or shutdown the system
- __1__: Single user mode
- __2__: Multi-user mode, without networking
- __3__: Full multi user mode, with NFS (typical for servers)
- __4__: Officially not defined; Unused
- __5__: Full multi user with NFS and graphics (typical for desktops)
- __6__: Reboot
- __s__,__S__ or single: Alternate single user mode
- __emergency__: Bypass rc.sysinit (discussed later in this article)

### The Chicken/Egg Module Problem and initrd

The kernel needs to mount the root filesystem (as specified in the second command above). This filesystem may be on some partition with one of the following capabilities:

- Logical Volume Management
- Software RAID
- NFS (Network File System)
- Some other encrypted partition

The Linux kernel does not have these features compiled into it by default.
The kernel needs to load these modules in order to mount the root filesystem.
These modules are present under __/lib/modules/__ directory, which is present on the root filesystem

__initrd__, the initial RAM disk - contains the modules needed to mount the filesystem, and only modules needed for that filesystem are included.

__GRUB__ also supports chainloading, the method used to pass control to other bootloader. Chainloading is used by GRUB to boot operating systems like windows.

### rc.sysinit does a lot

- Setting hostname
- It checks and mounts filesystems (/proc, /sys, and others in /etc/fstab).
- Enables SWAP
- Sets SELinux
- Configures kernel parameters from sysctl.conf
- Sets system clock
- Loads required modules
- Setting a minimal path
- Initializes required serial and other ports
- Enables RAID and LVM
- And the root filesystem, which was mounted read-only earlier (as specified in GRUB configuration file), is checked and remounted read-write.
